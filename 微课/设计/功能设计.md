### 概览

![outline](./src/outline.png)

### 功能概述

#### 角色划分

* 老师
* 学生
* 家长 - 父母、爷爷奶奶、外公外婆等
* 机构负责人
* 游客

1. 根据角色分配不同的页面
2. 角色可叠加，相应分配的页面可叠加
3. 注册时需要指定角色 - 只能指定一种角色
4. 分配角色 - 机构负责人可以给老师分配角色
5. 邀请 - 机构负责人、老师、家长、学生间可以互相邀请，邀请时需要给被邀请人指定角色；邀请时能指定的角色有（老师、学生、家长）
6. 角色变更 - 由机构负责人操作

#### 邀请机制

邀请人保存邀请记录，记录后期可编辑

被邀请人记录邀请人及角色

1. 机构负责人邀请：
   * 老师 - 分享小程序
   * 学生 - 可以查看该机构所由老师的课程信息 
   * 家长 - 可以查看该机构所由老师的课程信息 
2. 老师邀请：
   * 老师 - 分享小程序
   * 学生 - 可以查看该老师的课程信息
   * 家长 - 可以查看该老师的课程信息
3. 学生邀请：
   * 老师 - 可以查看该学生的课程信息
   * 学生 - 可以查看该学生的课程信息 （默认开启）
   * 家长 - 可以查看该学生的课程信息
4. 家长邀请：
   * 老师 - 可以查看该家长的小孩的课程信息
   * 学生 - 可以查看该家长的小孩的课程信息
   * 家长 - 可以查看该家长的小孩的课程信息 （默认开启）
5. 机构负责人添加老师、学生、家长时自动发送邀请消息
6. 老师添加学生、家长时自动发送邀请消息

#### 页面分配

* 机构负责人

  tab页: ["课程"， "约课"， "数据中心"，"我的"]

* 老师

  tab页: ["课程"， "约课"， "学员"， "我的"]

* 家长

  tab页: ["课程"，"预约"，"成长"， "我的"]

* 学生

  tab页: ["课程"，"预约"，"成长"， "我的"]

* 游客

  tab页: ["课程"， "我的"]

#### 注册

手机号、密码、称呼、角色、头像

称呼：

1. 机构负责人、老师、学生 可设置为昵称
2. 家长 设置为 **的爸爸等

#### 登录

1. 手机验证码登录
2. 微信登录

#### 付费

机构负责人：年订阅费 49元，月订阅费4.9元

老师：年订阅费29元，月订阅费2.9元

学生、家长：付费项目 - （添加课程表）年订阅费9元，月订阅费0.9元

#### 课程

* 机构负责人
  1. 默认显示自己的课程日历
  2. 导航栏左边需要有日历类型切换按钮和老师切换按钮
  3. 日历类型有：列表、月历、日历、周历
  4. 切换老师时，弹窗机构老师列表；选中老师后，显示该老师的课程日历
  5. 页面右下角有排课按钮，点击后进入排课页面 (需要会员权限)
* 老师
  1. 显示自己的课程日历
  2. 导航栏左边需要有日历类型切换按钮
  3. 日历类型有：列表、月历、日历、周历
  4. 页面右下角有排课按钮，点击后进入排课页面 (需要会员权限)
* 学生|家长
  1. 显示自己的课程日历
  2. 导航栏左边需要有日历类型切换按钮
  3. 日历类型有：列表、月历、日历、周历
  4. 对于付费用户，页面右下角有添加按钮，点击后进入课程及任务的编辑页面 (需要会员权限)

#### 排课 (需要会员权限)

* 选择排课学生|班级

  1. 没有学生|班级，则需要添加学生|创建班级
  2. 有学生|班级，则可单选
  3. 学生列表项中显示学生信息及课程信息
  4. 课程已经耗完的学生不能被选中，此时学生列表项显示续费按钮

* 选择课程标签

  1. 没有课程标签，则添加课程标签
  2. 有课程标签，则显示标签列表
  3. 课程标签列表项，单选

* 选择排课时间

  1. 选择课程的起始时间
  2. 如果是周期课程的话，可以将此排课时间应用到每一周

* 设置颜色标识 （可选）

  参考滴答清单

* 编辑描述信息 （可选）

  参考滴答清单

* 完成排查

  1. 在课程日历上显示排课信息
  2. 给学生、家长发排课消息

* 变更排课

  1. 点击排课信息，可以进行编辑
  2. 编辑完成后，点击变更按钮后将最新的排课信息显示在课程日历上
  3. 给学生、家长发排课变更消息

* 删除排课

  1. 给学生、家长发排课删除消息

* 上课前一小时、半小时、15分钟，分别发送消息，提示老师、学生、家长

* 课程正常结束半小时后，分别发送耗课消息给老师、机构负责人，并且自动|手动变更学生的课时余量

#### 约课

* 机构负责人
  1. 以卡片的形式展示机构的所有约课信息
  2. 约课信息可以单选|批量删除 (需要会员权限)
  3. 约课被确认后，从约课列表里删除，并且添加到老师和学生的课程日历里 (需要会员权限)
  4. 点击约课表项，进入到约课详情页面
  5. 在约课详情页面点击确认，则可以直接排课 (需要会员权限)
* 老师
  1. 以卡片的形式展示老师的所有约课信息
  2. 约课信息可以单选|批量删除
  3. 约课被确认后，从约课列表里删除，并且添加到老师和学生的课程日历里
  4. 点击约课表项，进入到约课详情页面
  5. 在约课详情页面点击确认，则可以直接排课
* 学生|家长
  1. 约课页面右下角有约课按钮，点击后进入约课页面
  2. 约课后发送约课消息给老师和机构负责人
  3. 约课信息可以单选|批量删除
  4. 未被确认的约课和已被确认的约课分组显示，并且约课表项视图区别显示
  5. 点击约课卡片，进入约课编辑页面

#### 数据中心

1. 总在读学员数
2. 总售课数
3. 总售课金额
4. 总耗课数
5. 总耗课金额
6. 总剩余课数
7. 按时间段统计售课数、售课金额、耗课数、耗课金额
8. 总意向学员数
9. 新增意向学员数
10. 总报名数
11. 按时间段统计意向学员数、新增意向学员数、报名数
12. 总收入
13. 总支出
14. 总结余
15. 按时间段统计收入、支出

#### 学员

1. 信息的录入/删除/编辑/查询，在web端可从excel批量录入
2. 信息 - 姓名、性别、头像、所属机构(foreignKey)、代课老师([foreignKey])、绑定手机、报名时间、课程(foreignKey)、总课时数(foreignKey)、消耗课时数，家长([foreignKey])，出生日期，标签，课程记录(foreignKey)，老师点评(foreignKey)
3. 通过（名字，标签）搜索

#### 成长

学生的上课记录

记录项显示：

1. 机构名称
2. 授课老师
3. 授课时间
4. 授课内容
5. 课程信息
6. 老师点评

#### 我的

* 机构负责人

  1. 机构logo
  2. 机构名称
  3. 机构负责人头像
  4. 机构负责人昵称
  5. 课程管理
  6. 班级管理
  7. 老师管理
  8. 机构信息设置
  9. 邀请
  10. 新手指南
  11. 帮助与反馈
  12. 关于

* 老师

  1. 老师昵称

  2. 老师头像
  3. 授课信息
  4. 所属机构
  5. 邀请
  6. 新手指南
  7. 帮助与反馈
  8. 关于

* 学生|家长

  1. 昵称
  2. 头像
  3. 我的老师
  4. 我的课程
  5. 邀请
  6. 新手指南
  7. 帮助与反馈
  8. 关于

### 详细设计

#### 邀请规则

*邀请是作为信息录入的一种替代方案，邀请方通过发送小程序分享消息给被邀请方，消息中携带邀请方的userId（即wk-users表的主键id）、被邀请方的角色；被邀请方同意后，被邀请方的角色以及双方的关系会被确定下来*

*如果双方的角色关系已经被确定下来，则被邀请方回略此邀请操作*

1. 机构负责人邀请老师
   * 发邀请消息给老师，消息中携带自己的userId、被邀请者的角色id，这里的roleId=2 表示老师
   * 被邀请者点击小程序消息，进入小程序后，获取用户的unionId，调用接口查询：
     * 若用户未注册过
       * 通过微信接口能力获取用户基础信息进行注册
       * 弹窗提示用户，被邀请为某机构的老师
       * 点击同意按钮，则更新该用户wk-users表记录的roles和orgIds字段
     * 若用户已经注册过
       * 查询该用户与是否是邀请者相应机构的老师，是的话，则忽略；否则继续以下操作
       * 弹窗提示用户，被邀请为某机构的老师
       * 点击同意按钮，则更新该用户wk-users表记录的roles和orgIds字段
2. 机构负责人邀请学生

#### Users表

表名：wk-users

| 字段            | 类型      | 必填 | 描述                                       |
| --------------- | --------- | ---- | ------------------------------------------ |
| _id             | Object ID | 是   | 存储文档 ID，系统自动生成                  |
| nickName        | String    | 否   | 用户昵称                                   |
| avatarUrl       | String    | 否   | 用户头像图片的 URL                         |
| gender          | Integer   | 否   | 用户性别：0 未知 1 男性 2 女性             |
| birthday        | Timestamp | 否   | 出生日期                                   |
| roles           | Array     | 否   | 1 机构负责人 2 老师 3 学生 4 家长          |
| register_date   | Timestamp | 是   | 注册时间                                   |
| last_login_date | Timestamp | 否   | 最后登录时间                               |
| mobile          | String    | 否   | 手机号码                                   |
| orgIds          | Array     | 否   | 用户所在机构的集合 （关联wk-orgs表的主键） |
| expire_date     | Timestamp | 是   | 过期时间                                   |

#### Mobile表

表名：wk-mobiles

| 字段              | 类型      | 必填 | 描述                                 |
| ----------------- | --------- | ---- | ------------------------------------ |
| _id               | Object ID | 是   | 存储文档 ID（用户 ID），系统自动生成 |
| mobile            | String    | 是   | 手机号码，不允许重复                 |
| password          | String    | 是   | 密码，加密保存                       |
| smscode           | String    | 否   | 最新手机验证码                       |
| userId            | Object ID | 是   | 用户id，外键 （关联wk-users的主键）  |
| last_smscode_date | Timestamp | 否   | 最近一次收到验证码的时间戳           |

#### WX表

表名：wk-wx

| 字段       | 类型      | 必填 | 描述                                |
| ---------- | --------- | ---- | ----------------------------------- |
| _id        | Object ID | 是   | 存储文档 ID，系统自动生成           |
| wx_unionid | String    | 是   | 微信unionid                         |
| wx_openid  | String    | 否   | 微信小程序平台openid                |
| userId     | Object ID | 是   | 用户id，外键 （关联wk-users的主键） |

#### Mobile表与WX表的关联表

表名：wk-mobiles-wx

| 字段     | 类型      | 必填 | 描述                                  |
| -------- | --------- | ---- | ------------------------------------- |
| _id      | Object ID | 是   | 存储文档 ID，系统自动生成             |
| mobileId | Object ID | 是   | 外键，用户id （关联wk-mobiles的主键） |
| wxId     | Object ID | 是   | 外键，微信id（关联wk-wx的主键）       |

##### 关联操作

1. 通过表wk-mobiles-wx获取对应的关联记录
2. 获取该关联记录的mobile和wxId，分别查询Mobiles表和WX表，获取对应的表记录 
3. 通过各表记录的外键userId，分别获取相应的Users表记录
4. 将这两条Users表记录的内容合并，然后将合并的内容插入到Users表并获取新记录的主键id
5. 更新Mobiles表和WX表中相应表记录的userId字段为新记录的主键id
6. 删除Users表中对应的那两条表记录

#### 机构表

表名：wk-orgs

| 字段 | 类型      | 必填 | 描述                      |
| ---- | --------- | ---- | ------------------------- |
| _id  | Object ID | 是   | 存储文档 ID，系统自动生成 |
| name | String    | 是   | 机构名称                  |
| tel  | String    | 否   | 座机号                    |
| addr | String    | 否   | 地址                      |
| desc | String    | 否   | 描述                      |
| logo | String    | 否   | 机构logo的url             |
|      |           |      |                           |

#### 机构评价表

表名：wk-org-rate

| 字段    | 类型      | 必填 | 描述                                         |
| ------- | --------- | ---- | -------------------------------------------- |
| _id     | Object ID | 是   | 存储文档 ID，系统自动生成                    |
| rate    | Integer   | 是   | 评分 0 无 1 非常差 2 差 3 一般 4 好 5 非常好 |
| comment | String    | 否   | 评论                                         |
| userId  | Object ID | 是   | 外键，用户id（关联wk-users的主键）           |
| orgId   | Object ID | 是   | 外键，机构id（关联wk-users的主键）           |

#### 老师表

表名：wk-teachers

| 字段       | 类型      | 必填 | 描述                               |
| ---------- | --------- | ---- | ---------------------------------- |
| _id        | Object ID | 是   | 存储文档 ID，系统自动生成          |
| studentIds | Array     | 否   | 学生id集合 （关联wk-students）     |
| userId     | Object ID | 是   | 外键，用户id（关联wk-users的主键） |

#### 班级表

表名：wk-class

| 字段 | 类型      | 必填 | 描述                      |
| ---- | --------- | ---- | ------------------------- |
| _id  | Object ID | 是   | 存储文档 ID，系统自动生成 |
|      |           |      |                           |
|      |           |      |                           |

#### 学生表

表名：wk-students

| 字段     | 类型      | 必填 | 描述                               |
| -------- | --------- | ---- | ---------------------------------- |
| _id      | Object ID | 是   | 存储文档 ID，系统自动生成          |
| userId   | Object ID | 是   | 外键，用户id（关联wk-users的主键） |
| parentId | Array     | 否   | 家长id集合（关联wk-users）         |

#### 课程表

表名：wk-courses

| 字段 | 类型      | 必填 | 描述                      |
| ---- | --------- | ---- | ------------------------- |
| _id  | Object ID | 是   | 存储文档 ID，系统自动生成 |
|      |           |      |                           |
|      |           |      |                           |

#### 模拟验证

注册：

* 微信授权注册
  1. 获取wx_unionid和wx_openid
  2. 获取用户个人信息并添加到wk-users表
  3. 添加wk-wx表记录，外键关联wk-users表记录
* 手机号密码注册
  1. 获取用户输入的个人信息，添加到wk-users表
  2. 保存手机号及密码到wk-mobiles表，外键关联wk-users表记录
* 后台录入 - 需要是机构负责人 （录入老师、学生、家长信息）
  * 如果录入用户的信息已经存在，则过滤此录入操作
  * 录入前要先创办机构
  * 将录入信息添加到wk-users表，并且更新相应表项的orgIds字段
  * 将手机号及密码添加到wk-mobiles表，外键关联wk-users表记录
* 老师注册 - 同时添加相应信息到wk-teachers表
* 学生注册 - 同时添加相应信息到wk-students表

登录：

* 微信登录 - 获取wx_unionid并后台验证，成功则返回userId
* 手机号密码登录
  1. 验证手机号及密码，成功则返回userId
  2. 忘记密码 - 通过验证码登录 ：
     * 下发验证码并保存至wk-mobiles表，更新相应表项的last_smscode_date字段
     * 验证手机号及验证码，并且last_smscode_date在最近5分钟内，成功则返回userId
  3. 修改密码
     * 输入原始密码
     * 两次输入新密码
     * 验证，成功则更新wk-mobiles表记录password字段
  4. 自动绑定微信登录

绑定：

* 绑定手机号
  * 如果待绑定的手机号在wk-mobiles表中存在，则提示该用户已经存在，请用手机号和密码登录
  * 下发验证码
  * 内存保存该用户的wx_unionid与手机号、验证码的对应关系，并且记录时间戳
  * 在5分钟内，用户输入验证码，登录密码；验证成功后，则保存信息到wk-mobiles表，同时新增wk-mobiles-wx表记录
  * 删除对应的内存数据
* 绑定微信
  * 获取wx_unionid
  * 添加wk-wx及wk-mobiles-wx表记录

机构负责人创建机构：

* 录入机构信息到wk-orgs表
* 将orgId添加到wk-users表的orgIds字段







##### 登录方式

* 微信授权登录
* 手机验证码登录

