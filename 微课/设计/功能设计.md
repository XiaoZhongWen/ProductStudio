## 概览

![outline](./src/outline.png)

## 详细设计

### 数据库表设计

#### Users表

表名：wk-users

| 字段             | 类型      | 必填 | 描述                                                  |
| ---------------- | --------- | ---- | ----------------------------------------------------- |
| _id              | Object ID | 是   | 存储文档 ID，系统自动生成                             |
| nickName         | String    | 否   | 用户昵称                                              |
| avatarUrl        | String    | 否   | 用户头像图片的 URL                                    |
| gender           | Integer   | 否   | 用户性别：0 未知 1 男性 2 女性                        |
| birthday         | Timestamp | 否   | 出生日期                                              |
| roles            | Array     | 否   | 1 机构负责人 2 老师 3 学生 4 家长                     |
| registerDate     | Timestamp | 是   | 注册时间                                              |
| lastLoginDate    | Timestamp | 否   | 最后登录时间                                          |
| mobile           | String    | 否   | 手机号码                                              |
| orgIds           | Array     | 否   | 用户所在机构的集合 （关联wk-orgs表的主键）限制最大100 |
| orgExpireDate    | Timestamp | 是   | 过期时间                                              |
| familyExpireDate | Timestamp | 是   | 过期时间                                              |
| status           | Integer   | 否   | 0：在读、1：结课、2：退费                             |
| addr             | String    | 否   | 住址                                                  |
| school           | String    | 否   | 学校                                                  |
| grade            | String    | 否   | 年级                                                  |
| parentIds        | Array     | 否   | 家长id集合                                            |
| tags             | Array     | 否   | 标签                                                  |
| inputCount       | Integer   | 是   | 机构负责人或老师录入的用户数，默认为0，最大500        |

#### 映射表

表名：wk-mapping

| 字段      | 类型      | 必填 | 描述                                   |
| --------- | --------- | ---- | -------------------------------------- |
| id        | Object ID | 是   | 存储文档 ID，系统自动生成              |
| teacherId | Object ID | 是   | 外键、老师id（关联wk-users的主键）     |
| studentId | Object ID | 是   | 外键、学生id（关联wk-users的主键）     |
| courseId  | Object ID | 是   | 外键、课程id（关联wk-users的主键）     |
| classId   | Object ID | 否   | 外键、班级id（关联wk-classes的主键id） |

#### Mobile表

表名：wk-mobiles

| 字段            | 类型      | 必填 | 描述                                 |
| --------------- | --------- | ---- | ------------------------------------ |
| _id             | Object ID | 是   | 存储文档 ID（用户 ID），系统自动生成 |
| mobile          | String    | 是   | 手机号码，不允许重复                 |
| password        | String    | 否   | 密码，加密保存                       |
| smscode         | String    | 否   | 最新手机验证码                       |
| userId          | Object ID | 是   | 用户id，外键 （关联wk-users的主键）  |
| lastSmscodeDate | Timestamp | 否   | 最近一次收到验证码的时间戳           |

#### WX表

表名：wk-wx

| 字段       | 类型      | 必填 | 描述                                |
| ---------- | --------- | ---- | ----------------------------------- |
| _id        | Object ID | 是   | 存储文档 ID，系统自动生成           |
| wx_unionid | String    | 是   | 微信unionid                         |
| wx_openid  | String    | 否   | 微信小程序平台openid                |
| userId     | Object ID | 是   | 用户id，外键 （关联wk-users的主键） |

#### Mobile表与WX表的关联表

表名：wk-mobiles-wx

| 字段     | 类型      | 必填 | 描述                                  |
| -------- | --------- | ---- | ------------------------------------- |
| _id      | Object ID | 是   | 存储文档 ID，系统自动生成             |
| mobileId | Object ID | 是   | 外键，用户id （关联wk-mobiles的主键） |
| wxId     | Object ID | 是   | 外键，微信id（关联wk-wx的主键）       |

#### 机构表

表名：wk-orgs

| 字段       | 类型      | 必填 | 描述                      |
| ---------- | --------- | ---- | ------------------------- |
| _id        | Object ID | 是   | 存储文档 ID，系统自动生成 |
| name       | String    | 是   | 机构名称                  |
| tel        | String    | 否   | 座机号                    |
| addr       | String    | 否   | 地址                      |
| desc       | String    | 否   | 描述                      |
| logo       | String    | 否   | 机构logo的url             |
| createTime | Timestamp | 是   | 机构的创建时间            |

#### 班级表

表名：wk-classes

| 字段 | 类型      | 必填 | 描述                      |
| ---- | --------- | ---- | ------------------------- |
| _id  | Object ID | 是   | 存储文档 ID，系统自动生成 |
| name | String    | 是   | 班级名称                  |
| desc | String    | 否   | 班级简介                  |
| icon | String    | 否   | 字体图标                  |

#### 课程表

表名：wk-courses

| 字段      | 类型      | 必填 | 描述                               |
| --------- | --------- | ---- | ---------------------------------- |
| _id       | Object ID | 是   | 存储文档 ID，系统自动生成          |
| name      | String    | 是   | 课程名称                           |
| desc      | String    | 否   | 课程简介                           |
| icon      | String    | 否   | 字体图标                           |
| orgId     | Object ID | 否   | 课程所属机构id                     |
| teacherId | Object ID | 否   | 课程所属老师id                     |
| type      | Integer   | 是   | 课程类型：0 一对一 ，1 班课，2次课 |
| duration  | Integer   | 是   | 时长，如45分钟、60分钟             |

***注：课程必须从属于机构或老师，如果老师从属于某机构，那么老师添加课程时，表记录的orgId记录该机构的id，teacherId为空；如果老师不从属于机构，那么表记录的orgId为空，teacherId记录该老师的id***

#### 排课表

表名：wk-schedules

| 字段           | 类型      | 必填 | 描述                                                       |
| -------------- | --------- | ---- | ---------------------------------------------------------- |
| _id            | Object ID | 是   | 存储文档 ID，系统自动生成                                  |
| teacherId      | Object ID | 是   | 外键，授课老师id （关联wk-users表的主键id）                |
| studentId      | Object ID | 否   | 外键，学生id（关联wk-users表的主键id）                     |
| date           | Timestamp | 是   | 排课操作时间                                               |
| startTime      | Timestamp | 是   | 开始时间                                                   |
| endTime        | Timestamp | 是   | 结束时间                                                   |
| repeatType     | Integer   | 是   | 默认是0, 0 不重复、1 每天、 2 每个工作日、3每个周末、4每周 |
| courseId       | Object ID | 是   | 外键，课程id （关联wk-courses表的主键id）                  |
| classId        | Object ID | 否   | 外键，班级id （关联wk-classes的主键）                      |
| studentIds     | Array     | 否   | 班级上课的学生id集合（关联wk-users表的主键id）             |
| courseContent  | String    | 否   | 上课内容                                                   |
| previewContent | String    | 否   | 预习内容                                                   |
| color          | String    | 否   | 颜色标签                                                   |

***注意:***

***1. 每个记录的teacherId、studentId、startTime、endTime不能完全一样***

***2. 对于机构管理员，可以查看、添加、删除、修改所在机构学生、老师的排课表记录***

***3. 对于老师，可以添加排课表记录，查看学生的排课表信息，删除、修改自己的排课表记录***

***4. 对于学生，可以查看自己的排课表信息***

#### 课程记录表

表名：wk-course-records

| 字段          | 类型      | 必填 | 描述                                           |
| ------------- | --------- | ---- | ---------------------------------------------- |
| _id           | Object ID | 是   | 存储文档 ID，系统自动生成                      |
| courseId      | Object ID | 是   | 外键，课程id （关联wk-courses表的主键id）      |
| teacherId     | Object ID | 是   | 外键，授课老师id （关联wk-users表的主键id）    |
| studentId     | Object ID | 否   | 学生的id （wk-users表的主键id）                |
| startTime     | Timestamp | 是   | 开始时间                                       |
| endTime       | Timestamp | 是   | 结束时间                                       |
| classId       | Object ID | 否   | 外键，班级id （关联wk-classes的主键）          |
| studentIds    | Array     | 否   | 班级上课的学生id集合（关联wk-users表的主键id） |
| feedback      | Array     | 否   | 老师的课程反馈                                 |
| courseContent | String    | 否   | 上课内容                                       |

#### 请假表

表名：wk-absence

| 字段       | 类型      | 必填 | 描述                                      |
| ---------- | --------- | ---- | ----------------------------------------- |
| _id        | Object ID | 是   | 存储文档 ID，系统自动生成                 |
| userId     | Object ID | 是   | 外键，用户id （关联wk-users表主键id）     |
| scheduleId | Object ID | 是   | 外键，排课id （关联wk-schedules表主键id） |
| desc       | String    | 否   | 原因                                      |

#### 缴费记录表

表名：wk-payment-records

| 字段      | 类型      | 必填 | 描述                                    |
| --------- | --------- | ---- | --------------------------------------- |
| _id       | Object ID | 是   | 存储文档 ID，系统自动生成               |
| studentId | Object ID | 是   | 外键，学生id （关联wk-users表主键id）   |
| date      | Timestamp | 是   | 购买课程时间戳                          |
| courseId  | Object ID | 是   | 外键，课程id （关联wk-courses表主键id） |
| count     | Integer   | 是   | 购买的课时数/课次数                     |
| price     | float     | 是   | 缴费金额                                |

#### 订单记录表

表名：wk-order-records

| 字段    | 类型      | 必填 | 描述                                   |
| ------- | --------- | ---- | -------------------------------------- |
| _id     | Object ID | 是   | 存储文档 ID，系统自动生成              |
| orderId | Object ID | 是   | 外键、订单id （关联wk-orders表主键id） |
| date    | Timestamp | 是   | 订单时间                               |
| price   | float     | 是   | 订单金额                               |
| userId  | Object ID | 是   | 外键，用户id（关联wk-users的主键）     |

#### 订单表

表名：wk-orders

| 字段         | 类型      | 必填 | 描述                                   |
| ------------ | --------- | ---- | -------------------------------------- |
| _id          | Object ID | 是   | 存储文档 ID，系统自动生成              |
| type         | Integer   | 是   | 0: 月付订单、1: 年付订单、2：一个月    |
| teacherPrice | price     | 是   | 月付订单：4.9，年付订单：50，一个月：6 |
| studentPrice | price     | 是   | 月付订单：2.9，年付订单：30，一个月：5 |
| memberType   | Integer   | 是   | 1：机构会员 2：家庭会员                |

## 业务逻辑

### 注册

1. 手机号密码注册
2. 信息录入

![wk-register](../../src/wk-register.png)

3. 录入

   ***如果对方信息已经被录入，则录入时仅仅更新关系字段***

   * 机构负责人录入

     ![wk-register](../../src/wk-typeIn-admin.png)

   

   * 老师录入

     ![wk-register](../../src/wk-typeIn-teacher.png)

### 登录

![wk-register](../../src/wk-login.png)

### 角色

1. 初次登录成功后自定义角色
2. 分配角色
   * 机构管理员录入信息时指定老师、学生、家长角色
   * 老师录入信息时指定学生、家长角色
   * 学生邀请老师、家长
   * 家长邀请老师
